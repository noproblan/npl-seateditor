<!DOCTYPE HTML>
<html>
  <head>
    <style>
      body {
        margin: 0;
        padding: 3px;
		font-family: Verdana, sans-serif;
      }
      canvas {
        border: 1px solid #9C9898;
      }
	  #menu-container {
		float:left;
	  }
	  #menu-container input {
		width: 60px;
	  }
	  #menu-container select {
		width: 100%;
	  }
	  #canvas-container {
		margin: 2px;
		float: left;
	  }
	  #info-container { // with selection hack
		-ms-user-select: none;
		-webkit-user-select: none;
		-moz-user-select: none;
		-khtml-user-select: none;
		padding: 20px;
		clear: both;
	  }
	  #init-controls button {
		width: 100%;
	  }
    </style>
	
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
	<script src="js/kinetic-v3.10.5.min.js"></script>
    <script src="js/functions.js"></script>
    <script>
		var selectedDesk = {
			_desk: null,
			set: function(desk) {
				this.onDeselect();
				this._desk = desk;
				this.onSelect();
				this._desk.getParent().draw();
			},
			get: function() {
				return this._desk;
			},
			onSelect: function() {
				this._desk.getChildren()[0].setStroke('red');
			},
			onDeselect: function() {
				if (this._desk) {
					this._desk.getChildren()[0].setStroke('black');
				}
			}
		};
		
		var createDesk = function(paramX, paramY, paramRotation) {
			this.createSeat = function(initialX, initialY) {
				var rect = new Kinetic.Rect({
				  x: initialX,
				  y: initialY,
				  height: 30,
				  width: 30,
				  fill: "orange",
				  stroke: "black",
				  strokeWidth: 1
				});
				return rect;
			}
		
			var desk = new Kinetic.Rect({
			  height: 80,
			  width: 180,
			  fill: "#00D2FF",
			  stroke: "black",
			  strokeWidth: 3
			});
			var group = new Kinetic.Group({
			  height: 80,
			  width: 180,
			  x: paramX,
			  y: paramY,
			  rotation: paramRotation * Math.PI / 180,
			  draggable: true
			});
			group.add(desk);
			
			var leftSeat = createSeat(30, 23);
			group.add(leftSeat);
			var rightSeat = createSeat(120, 23);
			group.add(rightSeat);

			group.on("click dragstart", function(e) {
				selectedDesk.set(this);
			});
			
			// Desk kopieren
			group.on("dblclick", function(e) {
				var newDesk = createDesk(this.getX() + 50,this.getY() + 30,this.getRotationDeg());
				this.getParent().add(newDesk);
				selectedDesk.set(newDesk);
			});
			
			return group;
		}

		var updatePropertyList = function(desk) {
			document.getElementById('current-index').value = desk.index;
			document.getElementById('current-x').value = desk.getPosition().x;
			document.getElementById('current-y').value = desk.getPosition().y;
			document.getElementById('current-rotation').value = desk.getRotationDeg();
		}
		
		var updateDeskList = function(kineticsLayer) {
			var oldValue = $('#desklist').val();
			$('#desklist').empty();
			$.each(kineticsLayer.getChildren(), function(index, value) {
			  document.getElementById('desklist').innerHTML += '<option value="'+index+'">'+index+'</option>';
			});
			if (oldValue !== null) {
				$('#desklist').val(oldValue);
			}
		}
		
      window.onload = function() {
	    var stage = new Kinetic.Stage({
          container: "canvas-container",
          width: 1000,
          height: 500
        });
		var deskLayer = new Kinetic.Layer();
		stage.add(deskLayer);
		stage.setScale(0.5);
		
		/* EVENTS *******************************************************************/
		stage.on("click dragend", function(e) {
			updateDeskList(deskLayer);
			var currentDesk = selectedDesk.get();
			if (currentDesk) {
				document.getElementById('desklist').options[currentDesk.index].selected = true;
				updatePropertyList(currentDesk);
			}
		});

		// Desk Movement
		window.onkeydown = function(e) {
			var key = {w: 87, a: 65, s: 83, d: 68, q: 81, e: 69};
			switch (e.keyCode) { // check, ob mich die gedrückte Taste was angeht
				case key.w: // nach oben
				case key.a: // nach links
				case key.s: // nach unten
				case key.d: // nach rechts
				case key.q: // drehen im Gegenuhrzeigersinn
				case key.e: // drehen im Uhrzeigersinn
					var desk = selectedDesk.get();
					if (desk) {
						switch(e.keyCode) {
							case key.w:
								var y = Math.round(desk.getPosition().y/10)*10
								desk.setY(y-10);
							break;
							case key.a:
								var x = Math.round(desk.getPosition().x/10)*10
								desk.setX(x-10);
							break;
							case key.s:
								var y = Math.round(desk.getPosition().y/10)*10
								desk.setY(y+10);
							break;
							case key.d:
								var x = Math.round(desk.getPosition().x/10)*10
								desk.setX(x+10);
							break;
							case key.q:
								var rot = Math.round(desk.getRotationDeg()/10)*10
								desk.setRotationDeg((rot-10)%360);
							break;
							case key.e:
								var rot = Math.round(desk.getRotationDeg()/10)*10
								desk.setRotationDeg((rot+10)%360);
							break;
						}
						updatePropertyList(desk);
						desk.getParent().draw();
					}
				break;
			}
		}
		
		document.getElementById('desklist').onchange = function() {
			var oldDesk = selectedDesk.get();
			if (oldDesk) {
				var index = parseInt($(this).val());
				var newDesk = oldDesk.getParent().getChildren()[index];
				selectedDesk.set(newDesk);
				updatePropertyList(newDesk);
			}
		};
		
		document.getElementById('current-x').onchange = function() {
			var desk = selectedDesk.get();
			if (desk) {
				desk.setX(parseInt(this.value));
				desk.getParent().draw();
			}
		}
		document.getElementById('current-y').onchange = function() {
			var desk = selectedDesk.get();
			if (desk) {
				desk.setY(parseInt(this.value));
				desk.getParent().draw();
			}
		}
		document.getElementById('current-rotation').onchange = function() {
			var desk = selectedDesk.get();
			if (desk) {
				desk.setRotationDeg(parseFloat(this.value));
				desk.getParent().draw();
			}
		}
		
		document.getElementById('add-2-button').onclick = function() {
			var desk = createDesk(5,5,0);
			deskLayer.add(desk);
			deskLayer.draw();
		};
		document.getElementById('add-1-button').onclick = function() {
			var desk = createDesk(5,5,0);
			deskLayer.add(desk);
			deskLayer.draw();
		};
      };

    </script>
  </head>
  <body>
    <div id="menu-container">
		<div id="init-controls">
			<button id="add-2-button" name="add2Desk" type="button">+ 2er Tisch</button><br/>
			<button id="add-1-button" name="add1Desk" type="button">+ 1er Tisch</button>
		</div>
		
		<div id="desklist-container">
			<select id="desklist" size="19">
			</select>
		</div>
		
		<div id="properties-container">
			<table>
				<tr>
					<td>Index: </td>
					<td><input id="current-index" name="current-index" type="text" readonly="readonly"/></td>
				</tr>
				<tr>
					<td>X: </td>
					<td><input id="current-x" name="current-x" type="text"/></td>
				</tr>
				<tr>
					<td>Y: </td>
					<td><input id="current-y" name="current-y" type="text"/></td>
				</tr>
				<tr>
					<td>Rot: </td>
					<td><input id="current-rotation" name="current-rotation" type="text"/></td>
				</tr>
			</table>
		</div>
	</div>

	<div id="canvas-container"></div>
	
	<div id="info-container">
		<p>- Use w,a,s,d for movement and q,e for rotation.</p>
		<p>- Double click on the canvas to create a new desk.</p>
	</div>

  </body>
</html>

